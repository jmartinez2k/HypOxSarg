---
title: "MSThesis_JM"
author: "Jose Martinez"
date: "2024-06-02"
output: html_document
---
```{r}
#load required libraries

library(ggplot2);library(scales);library(ggridges);library(dplyr);library(ggthemes);library(patchwork);library(gsw);library(tidyverse);
library(readr);library(DescTools);library(ggmap);library(pastecs);library(forcats);library(reshape2);library(lubridate);library(paletteer);library(hms);library(plotly);library(data.table);library(readxl);library(ggplot2);library(imputeTS);library(xts);library(cowplot);library(ggeffects);library(nlme);library(rsq);library(grid);library(gridExtra)

```

# 2023 Late Summer Data

```{r}
#Current Data

currents_data_23 <- read_csv("2207205_Flow_Current_23.csv")


new_current_c <- c("Time","Speed (cm/s)","Heading (degrees)","Velocity-N (cm/s)","Velocity-E (cm/s)")
colnames(currents_data_23) = new_current_c

currents_data_23$Time <- as.POSIXct(currents_data_23$Time, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")

# Extract year, month, day, hour, and second
currents_data_23$Year <- year(currents_data_23$Time)
currents_data_23$Month <- month(currents_data_23$Time)
currents_data_23$Day <- day(currents_data_23$Time)
currents_data_23$Hour <- hour(currents_data_23$Time)
currents_data_23$Minute <- minute(currents_data_23$Time)
currents_data_23$Second <- second(currents_data_23$Time)
currents_data_23$Sector <- cut((currents_data_23$`Heading (degrees)`%% 360), 
                            breaks = c(0, seq(22.5, 337.5, by = 45), 360), 
                            c("N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"))
currents_data_23$Sector <- recode(currents_data_23$Sector, "N" = "S", "S" = "N", "SE" = "NW", "NE" = "SW", "SW" = "NE",  "NW" = "SE", "W" = "E", "E" = "W")
currents_data_23 = currents_data_23 %>%
  filter(Time >= as.POSIXct("2023-08-18") & Time < as.POSIXct("2023-10-03"))

# Wind Data
wind_data_23 <- read_csv("NOAA_wind_23.csv")

wind_data_23$DateTime <- paste(wind_data_23$Date, wind_data_23$`Time (GMT)`)
wind_data_23$Time <- as.POSIXct(
  paste(wind_data_23$Date, wind_data_23$`Time (GMT)`),
  format = "%m/%d/%Y %H:%M", tz = "UTC" # Updated format for date and time
)
# Extract year, month, day, hour, and second
wind_data_23$Year <- year(wind_data_23$Time)
wind_data_23$Month <- month(wind_data_23$Time)
wind_data_23$Day <- day(wind_data_23$Time)
wind_data_23$Hour <- hour(wind_data_23$Time)
wind_data_23$Minute <- minute(wind_data_23$Time)
wind_data_23$Second <- second(wind_data_23$Time)


wind_data_23$Sector <- cut((wind_data_23$`Wind Dir (deg)` %% 360), 
                            breaks = c(0, seq(22.5, 337.5, by = 45), 360), 
                            labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"))

NOAA_water_level_23 <- read_csv("NOAA_water_level_23.csv")
NOAA_water_level_23$Time <- as.POSIXct(
  paste(NOAA_water_level_23$Date, NOAA_water_level_23$`Time (GMT)`),
  format = "%m/%d/%Y %H:%M", tz = "UTC" # Updated format for date and time
)

# Extract year, month, day, hour, and second
NOAA_water_level_23$Year <- year(NOAA_water_level_23$Time)
NOAA_water_level_23$Month <- month(NOAA_water_level_23$Time)
NOAA_water_level_23$Day <- day(NOAA_water_level_23$Time)
NOAA_water_level_23$Hour <- hour(NOAA_water_level_23$Time)
NOAA_water_level_23$Minute <- minute(NOAA_water_level_23$Time)
NOAA_water_level_23$Second <- second(NOAA_water_level_23$Time)
#NOAA_water_level_23$WL <- NOAA_water_level_23$`Verified (m)` + 2.082197917


```

## Dissolved Oxygen Sensors for Late Summer 2023

```{r}
#import miniDOT data
S1 <- read_csv("S1_Cat.TXT", skip = 6) %>% slice(-1)
S2 <- read_csv("S2_Cat.TXT", skip = 6) %>% slice(-1)
S3 <- read_csv("S3_Cat.TXT", skip = 6) %>% slice(-1)
S4 <- read_csv("S4_Cat.TXT", skip = 6) %>% slice(-1)

#convert miniDOT data to time series objects
S1_ts <- xts(as.numeric(S1$`Dissolved Oxygen`), order.by = as.POSIXlt(S1$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
S2_ts <- xts(as.numeric(S2$`Dissolved Oxygen`), order.by = as.POSIXlt(S2$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
S3_ts <- xts(as.numeric(S3$`Dissolved Oxygen`), order.by = as.POSIXlt(S3$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
S4_ts <- xts(as.numeric(S4$`Dissolved Oxygen`), order.by = as.POSIXlt(S4$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))

# Convert the temperature data to time series objects as well
S1_temp_ts <- xts(as.numeric(S1$Temperature), order.by = as.POSIXlt(S1$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
S2_temp_ts <- xts(as.numeric(S2$Temperature), order.by = as.POSIXlt(S2$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
S3_temp_ts <- xts(as.numeric(S3$Temperature), order.by = as.POSIXlt(S3$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
S4_temp_ts <- xts(as.numeric(S4$Temperature), order.by = as.POSIXlt(S4$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))

#create a common datetime to interpolate all data to a common timescale using the start of all sensors and the maximum of the two shortest deployments
common_datetime <- 
  seq.POSIXt(from = min(as.POSIXlt(S1$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S")),
             to = max(as.POSIXlt(S4$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S")),
             by = "15 mins")

#interpolate each miniDOT sensor to the common datetime
S1_2 = na_interpolation(merge(S1_ts, xts(,common_datetime)))
S2_2 = na_interpolation(merge(S2_ts, xts(,common_datetime)))
S3_2 = na_interpolation(merge(S3_ts, xts(,common_datetime)))
S4_2 = na_interpolation(merge(S4_ts, xts(,common_datetime)))

# Do the same for temperature
S1_temp_2 = na_interpolation(merge(S1_temp_ts, xts(,common_datetime)))
S2_temp_2 = na_interpolation(merge(S2_temp_ts, xts(,common_datetime)))
S3_temp_2 = na_interpolation(merge(S3_temp_ts, xts(,common_datetime)))
S4_temp_2 = na_interpolation(merge(S4_temp_ts, xts(,common_datetime)))

#merge the interpolated data together
S_2 = merge(S1_2, S2_2, S3_2, S4_2)
S_temp_2 = merge(S1_temp_2, S2_temp_2, S3_temp_2, S4_temp_2)

#remove rows with NA that are not interpolated to the same datetime
S_2_all = as.data.frame(S_2[complete.cases(S_2), ]) %>% rownames_to_column("datetime")
S_temp_2_all = as.data.frame(S_temp_2[complete.cases(S_temp_2), ]) %>% rownames_to_column("datetime")

#calculate the row-wise median from the data to find the central tendency of DO sensors

median_DO_23 = 
  S_2_all[,2:5] %>%
  rowwise() %>%
  summarize(median_DO_mg_L = median(c_across(where(is.numeric))),
            range_DO_mg_L = max(c_across(where(is.numeric)))-min(c_across(where(is.numeric))))

# Calculate the row-wise median temperature
median_temp_23 = 
  S_temp_2_all[,2:5] %>%
  rowwise() %>%
  summarize(median_temp = median(c_across(where(is.numeric))))

#merge the median DO with the datetime
DO_comparison_23 = as.data.frame(cbind(datetime=as.POSIXlt(S_2_all[,1], format="%Y-%m-%d %H:%M:%S"), S_2_all[,2:5], median_DO_23, median_temp_23))
# Extract date, time, and other components
DO_comparison_23$Year <- format(DO_comparison_23$datetime, "%Y")
DO_comparison_23$Month <- format(DO_comparison_23$datetime, "%m")
DO_comparison_23$Day <- format(DO_comparison_23$datetime, "%d")
DO_comparison_23$Hour <- format(DO_comparison_23$datetime, "%H")
DO_comparison_23$Minute <- format(DO_comparison_23$datetime, "%M")
DO_comparison_23$hm <- paste(hour(DO_comparison_23$datetime), minute(DO_comparison_23$datetime), sep = ":")
DO_comparison_23$Date <- as.Date(paste(DO_comparison_23$Year, DO_comparison_23$Month, DO_comparison_23$Day, sep = "-"), format = "%Y-%m-%d")


# Statistics of Oxygen Data in Late Summer 2023
DO_stats = DO_comparison_23 %>% 
  group_by(Date) %>% 
  summarize(mean_value = mean(median_DO_mg_L,na.rm = TRUE),
            mean_sd_value = sd(median_DO_mg_L, na.rm = TRUE),
            min_value = min(median_DO_mg_L,na.rm = TRUE),
            max_value = max(median_DO_mg_L,na.rm = TRUE))

temp_stats = DO_comparison_23 %>% 
  group_by(Date) %>% 
  summarize(mean_value = mean(median_temp,na.rm = TRUE),
            mean_sd_value = sd(median_temp, na.rm = TRUE),
            min_value = min(median_temp,na.rm = TRUE),
            max_value = max(median_temp,na.rm = TRUE))



```

# Duration Calculations for DO during Late Summer 2023

```{r}
# Based on Pezner et al., 2023 (https://doi.org/10.1038/s41558-023-01619-2): 

# After Hauri et al., 2013 (https://doi.org/10.1002/grl.5028): 
  #
  # Severity = Intensity * Duration
  #
  # where:
  # Intensity = threshold - mean during event
  #
  # so, 
  # Intensity = hyp_threshold - mean(DO)_hyp_event
  #
  # and
  # Duration = duration of hypoxic event of certain threshold
  
  ## Add ID columns for 4 thresholds (<5, <4, <3, and <2 Âµmol/kg) 
  DO_comparison_23 = DO_comparison_23 %>% 
    arrange(datetime) %>% 
    mutate(hyp_5_ID = ifelse(median_DO_mg_L <=5, 1, 0), #same as hyp_all_ID
           hyp_4_ID = ifelse(median_DO_mg_L <=4, 1, 0),
           hyp_3_ID = ifelse(median_DO_mg_L <=3 , 1, 0),
           hyp_2_ID = ifelse(median_DO_mg_L <=2, 1, 0)) #same as hyp_sev_ID 
  
### WORKING WITH INDIVIDUAL OBSERVATIONS  ---
  
  ## Where median_DO_mg_L < threshold, calculate intensity below threshold, otherwise put NA:
  intens_hyp_thresholds = DO_comparison_23 %>% 
    mutate(intens_5 = ifelse(median_DO_mg_L <=5, 5 - median_DO_mg_L, NA),
           intens_4 = ifelse(median_DO_mg_L <=4, 4 - median_DO_mg_L, NA),
           intens_3  = ifelse(median_DO_mg_L <=3, 3 - median_DO_mg_L, NA),
           intens_2  = ifelse(median_DO_mg_L <=2, 2 - median_DO_mg_L, NA))
  
  ## Calculate number of data points below each threshold for each `Temperature (*C)`:    
  num_intens = intens_hyp_thresholds %>% 
    group_by(datetime) %>% 
    summarize("5" = length(which(intens_5 > 0)),
              "4" = length(which(intens_4 > 0)),
              "3" = length(which(intens_3 > 0)),
              "2" = length(which(intens_2 > 0)))
  
  
  ### WORKING WITH EVENTS (groups of data points below threshold)  ---    
  
  ## Make data frame that groups by rle(hyp_all_ID), site, and proj and then takes average of median_DO_mg_L for each group where ID == 1
  # This will be part of intensity calculation  
  # Code source: https://stackoverflow.com/questions/59991203/how-to-group-consecutive-rows-having-same-event-and-find-average
  
  
  event_hyp_5 = DO_comparison_23 %>%
    arrange(datetime) %>%  #make sure Time is in order before grouping events
    group_by(Date,grp = rleid(hyp_5_ID)) %>% # Group by RLE of Time# group by RLE of hyp_5_ID as well
    summarise(ID = first(hyp_5_ID),
              mean_oxy = mean(median_DO_mg_L), # mean of median_DO_mg_L for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  event_hyp_4 = DO_comparison_23 %>%
    arrange(datetime) %>% 
    group_by(Date,grp = rleid(hyp_4_ID)) %>% # group by RLE of hyp_4_ID as well
    summarise(ID = first(hyp_4_ID),
              mean_oxy = mean(median_DO_mg_L), # mean of median_DO_mg_L for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  event_hyp_3 = DO_comparison_23 %>%
    arrange(datetime) %>% 
    group_by(Date,grp = rleid(hyp_3_ID)) %>% # group by RLE of hyp_3_ID as well
    summarise(ID = first(hyp_3_ID),
              mean_oxy = mean(median_DO_mg_L), # mean of median_DO_mg_L for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  event_hyp_2 = DO_comparison_23 %>%
    arrange(datetime) %>% 
    group_by(Date,grp = rleid(hyp_2_ID)) %>% # group by RLE of hyp_2_ID as well
    summarise(ID = first(hyp_2_ID),
              mean_oxy = mean(median_DO_mg_L), # mean of median_DO_mg_L for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  ## For hypoxic events only lasting 1 data point (1 row), the duration will be 0. Change 0's to 1x recording frequency instead (0.5hr), as this is the
  # theoretical mean duration of that "event". For example, if recording freq is every 30 min, then one data point of hypoxia could 
  # represent 30 min of hypoxia prior to that sampling time or also 30 min of hypoxia until the next sampling event, so 30 min is mean
  
  event_hyp_5$dur_hrs <- with(event_hyp_5, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_4$dur_hrs <- with(event_hyp_4, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_3$dur_hrs <- with(event_hyp_3, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_2$dur_hrs <- with(event_hyp_2, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_5 =  event_hyp_5 %>% 
    mutate(threshold = as.factor("5"))
  
  event_hyp_4 =  event_hyp_4 %>% 
    mutate(threshold = as.factor("4"))
  
  event_hyp_3 =  event_hyp_3 %>% 
    mutate(threshold = as.factor("3"))
  
  event_hyp_2 =  event_hyp_2 %>% 
    mutate(threshold = as.factor("2"))  
  
  events_hyp_all = rbind(event_hyp_5,event_hyp_4,event_hyp_3,event_hyp_2)
 
events_hyp_summary = events_hyp_all %>% 
    group_by(threshold) %>% 
    summarize(tot_dur = sum(dur_hrs),
              mean_dur = mean(dur_hrs),
              sd_dur = sd(dur_hrs))

```

# 2024 Late Winter Data

```{r}
#Current Data
current_data_24 <- read_csv("2207202_Flow_Current_24.csv")

#view(current_data_24)
new_current_c <- c("Time","Speed (cm/s)","Heading (degrees)","Velocity-N (cm/s)","Velocity-E (cm/s)")
colnames(current_data_24) = new_current_c

current_data_24$Time <- as.POSIXct(current_data_24$Time, format = "%Y-%m-%d %H:%M:%S", tz = "UTC")

# Extract year, month, day, hour, and second
current_data_24$Year <- year(current_data_24$Time)
current_data_24$Month <- month(current_data_24$Time)
current_data_24$Day <- day(current_data_24$Time)
current_data_24$Hour <- hour(current_data_24$Time)
current_data_24$Minute <- minute(current_data_24$Time)
current_data_24$Second <- second(current_data_24$Time)
current_data_24$Sector <- cut((current_data_24$`Heading (degrees)`%% 360), 
                            breaks = c(0, seq(22.5, 337.5, by = 45), 360), 
                            c("N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"))
current_data_24$Sector <- recode(current_data_24$Sector, "N" = "S", "S" = "N", "SE" = "NW", "NE" = "SW", "SW" = "NE",  "NW" = "SE", "W" = "E", "E" = "W")

# Wind Data
wind_data_24 <- read_csv("NOAA_wind_24.csv")


wind_data_24$DateTime <- paste(wind_data_24$Date, wind_data_24$`Time (GMT)`)
wind_data_24$Time <- as.POSIXct(
  paste(wind_data_24$Date, wind_data_24$`Time (GMT)`),
  format = "%m/%d/%Y %H:%M", tz = "UTC" # Updated format for date and time
)

# Extract year, month, day, hour, and second
wind_data_24$Year <- year(wind_data_24$Time)
wind_data_24$Month <- month(wind_data_24$Time)
wind_data_24$Day <- day(wind_data_24$Time)
wind_data_24$Hour <- hour(wind_data_24$Time)
wind_data_24$Minute <- minute(wind_data_24$Time)
wind_data_24$Second <- second(wind_data_24$Time)

wind_data_24$`Wind Speed (kn)` <- as.numeric(as.character(wind_data_24$`Wind Speed (kn)`), na.rm = TRUE)
wind_data_24$`Wind Dir (deg)` <- as.numeric(as.character(wind_data_24$`Wind Dir (deg)`), na.rm = TRUE)

wind_data_24$Sector <- cut((wind_data_24$`Wind Dir (deg)` %% 360), 
                            breaks = c(0, seq(22.5, 337.5, by = 45), 360), 
                            labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW", "N")) # Add directions to degree of winds


NOAA_water_level_24 <- read_csv("NOAA_water_level_24.csv")
NOAA_water_level_24$Time <- as.POSIXct(
  paste(NOAA_water_level_24$Date, NOAA_water_level_24$`Time (GMT)`),
  format = "%m/%d/%Y %H:%M", tz = "UTC" # Updated format for date and time
)

# Extract year, month, day, hour, and second
NOAA_water_level_24$Year <- year(NOAA_water_level_24$Time)
NOAA_water_level_24$Month <- month(NOAA_water_level_24$Time)
NOAA_water_level_24$Day <- day(NOAA_water_level_24$Time)
NOAA_water_level_24$Hour <- hour(NOAA_water_level_24$Time)
NOAA_water_level_24$Minute <- minute(NOAA_water_level_24$Time)
NOAA_water_level_24$Second <- second(NOAA_water_level_24$Time)
NOAA_water_level_24$WL <- NOAA_water_level_24$`Verified (m)` + 1.957819444

```

# Oxygen Data Late Winter 2024

```{r setup, include=FALSE}
#import miniDOT data

X1 <- read_csv("X1_Cat.TXT", skip = 6) %>% slice(-1)
X2 <- read_csv("X2_Cat.TXT", skip = 6) %>% slice(-1)


#convert miniDOT data to time series objects
X1_ts <- xts(as.numeric(X1$`Dissolved Oxygen`), order.by = as.POSIXlt(X1$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
X2_ts <- xts(as.numeric(X2$`Dissolved Oxygen`), order.by = as.POSIXlt(X2$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))


# Convert the temperature data to time series objects as well
X1_temp_ts <- xts(as.numeric(X1$Temperature), order.by = as.POSIXlt(X1$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))
X2_temp_ts <- xts(as.numeric(X2$Temperature), order.by = as.POSIXlt(X2$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S"))


#create a common datetime to interpolate all data to a common timescale using the start of all sensors and the maximum of the two shortest deployments
common_datetime <- 
  seq.POSIXt(from = min(as.POSIXlt(X1$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S")),
             to = max(as.POSIXlt(X2$`UTC_Date_&_Time`, format="%Y-%m-%d %H:%M:%S")),
             by = "15 mins")

#interpolate each miniDOT sensor to the common datetime
X1_2 = na_interpolation(merge(X1_ts, xts(,common_datetime)))
X2_2 = na_interpolation(merge(X2_ts, xts(,common_datetime)))


# Do the same for temperature
X1_temp_2 = na_interpolation(merge(X1_temp_ts, xts(,common_datetime)))
X2_temp_2 = na_interpolation(merge(X2_temp_ts, xts(,common_datetime)))

#merge the interpolated data together
X_2 = merge(X1_2, X2_2)
X_temp_2 = merge(X1_temp_2, X2_temp_2)

#remove rows with NA that are not interpolated to the same datetime
X_2_all = as.data.frame(X_2[complete.cases(X_2), ]) %>% rownames_to_column("datetime")
X_temp_2_all = as.data.frame(X_temp_2[complete.cases(X_temp_2), ]) %>% rownames_to_column("datetime")

#calculate the row-wise median from the data to find the central tendency of DO sensors

mean_DO_24 = 
  X_2_all[,1:3] %>%
  rowwise() %>%
  summarize(mean_DO_mg_L = median(c_across(where(is.numeric))), # change to mean
            range_DO_mg_L = max(c_across(where(is.numeric)))-min(c_across(where(is.numeric))))

# Calculate the row-wise median temperature
mean_temp_24 = 
  X_temp_2_all[,1:3] %>%
  rowwise() %>%
  summarize(mean_temp = median(c_across(where(is.numeric))))

#merge the median DO with the datetime
DO_comparison_24 <- as.data.frame(cbind(datetime = as.POSIXlt(X_2_all[,1], format="%Y-%m-%d %H:%M:%S"), 
                                         X_2_all[,2:3], mean_DO_24, mean_temp_24))
# Extract date, time, and other components
DO_comparison_24$Year <- format(DO_comparison_24$datetime, "%Y")
DO_comparison_24$Month <- format(DO_comparison_24$datetime, "%m")
DO_comparison_24$Day <- format(DO_comparison_24$datetime, "%d")
DO_comparison_24$Hour <- format(DO_comparison_24$datetime, "%H")
DO_comparison_24$Minute <- format(DO_comparison_24$datetime, "%M")
DO_comparison_24$hm <- paste(hour(DO_comparison_24$datetime), minute(DO_comparison_24$datetime), sep = ":")
DO_comparison_24$Date <- as.Date(paste(DO_comparison_24$Year, DO_comparison_24$Month, DO_comparison_24$Day, sep = "-"), format = "%Y-%m-%d")


# Statistics of Oxygen Data in Late Summer 2024
DO_stats_24 = DO_comparison_24 %>% 
  group_by(Date) %>% 
  summarize(mean_value = mean(mean_DO_mg_L,na.rm = TRUE),
            mean_sd_value = sd(mean_DO_mg_L, na.rm = TRUE),
            min_value = min(mean_DO_mg_L,na.rm = TRUE),
            max_value = max(mean_DO_mg_L,na.rm = TRUE))

temp_stats_24 = DO_comparison_24 %>% 
  group_by(Date) %>% 
  summarize(mean_value = mean(mean_temp,na.rm = TRUE),
            mean_sd_value = sd(mean_temp, na.rm = TRUE),
            min_value = min(mean_temp,na.rm = TRUE),
            max_value = max(mean_temp,na.rm = TRUE))

```

# Duration Calculations of Late Winter 2024
```{r}

# Based on Pezner et al., 2023 (https://doi.org/10.1038/s41558-023-01619-2): 

# After Hauri et al., 2013 (https://doi.org/10.1002/grl.5028): 
  #
  # Severity = Intensity * Duration
  #
  # where:
  # Intensity = threshold - mean during event
  #
  # so, 
  # Intensity = hyp_threshold - mean(DO)_hyp_event
  #
  # and
  # Duration = duration of hypoxic event of certain threshold
  
  ## Add ID columns for 4 thresholds (<5, <4, <3, and <2 Âµmol/kg) 
  DO_comparison_24 = DO_comparison_24 %>% 
    arrange(datetime) %>% 
    mutate(hyp_5_ID = ifelse(mean_DO_mg_L <=5, 1, 0), #same as hyp_all_ID
           hyp_4_ID = ifelse(mean_DO_mg_L <=4, 1, 0),
           hyp_3_ID = ifelse(mean_DO_mg_L <=3, 1, 0),
           hyp_2_ID = ifelse(mean_DO_mg_L <=2, 1, 0)) #same as hyp_sev_ID 
  
### WORKING WITH INDIVIDUAL OBSERVATIONS  ---
  
  ## Where mean_DO_mg_L < threshold, calculate intensity below threshold, otherwise put NA:
  intens_hyp_thresholds_24 = DO_comparison_24 %>% 
    mutate(intens_5 = ifelse(mean_DO_mg_L <=5, 5 - mean_DO_mg_L, NA),
           intens_4 = ifelse(mean_DO_mg_L <=4, 4 - mean_DO_mg_L, NA),
           intens_3  = ifelse(mean_DO_mg_L <=3, 3 - mean_DO_mg_L, NA),
           intens_2  = ifelse(mean_DO_mg_L <=2, 2 - mean_DO_mg_L, NA))
  
  ## Calculate number of data points below each threshold for each `Temperature (*C)`:    
  num_intens_24 = intens_hyp_thresholds_24 %>% 
    group_by(datetime) %>% 
    summarize("5" = length(which(intens_5 > 0)),
              "4" = length(which(intens_4 > 0)),
              "3" = length(which(intens_3 > 0)),
              "2" = length(which(intens_2 > 0)))
  
  
  ### WORKING WITH EVENTS (groups of data points below threshold)  ---    
  
  ## Make data frame that groups by rle(hyp_all_ID), site, and proj and then takes average of mean_DO_mg_L for each group where ID == 1
  # This will be part of intensity calculation  
  # Code source: https://stackoverflow.com/questions/59991203/how-to-group-consecutive-rows-having-same-event-and-find-average
  
  
  event_hyp_5_24 = DO_comparison_24 %>%
    arrange(Date) %>%  #make sure Time is in order before grouping events
    group_by(Date, grp = rleid(hyp_5_ID)) %>% # Group by RLE of Time# group by RLE of hyp_5_ID as well
    summarise(ID = first(hyp_5_ID),
              mean_oxy = mean(mean_DO_mg_L), # mean of DO for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  event_hyp_4_24 = DO_comparison_24 %>%
    arrange(Date) %>% 
    group_by(Date, grp = rleid(hyp_4_ID)) %>% # group by RLE of hyp_4_ID as well
    summarise(ID = first(hyp_4_ID),
              mean_oxy = mean(mean_DO_mg_L), # mean of DO for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  event_hyp_3_24 = DO_comparison_24 %>%
    arrange(Date) %>% 
    group_by(Date, grp = rleid(hyp_3_ID)) %>% # group by RLE of hyp_3_ID as well
    summarise(ID = first(hyp_3_ID),
              mean_oxy = mean(mean_DO_mg_L), # mean of DO for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  event_hyp_2_24 = DO_comparison_24 %>%
    arrange(Date) %>% 
    group_by(Date, grp = rleid(hyp_2_ID)) %>% # group by RLE of hyp_2_ID as well
    summarise(ID = first(hyp_2_ID),
              mean_oxy = mean(mean_DO_mg_L), # mean of DO for run of 1's
              dur_hrs = as.numeric(difftime(last(datetime), first(datetime),units="hours"))) %>%  
    filter(ID == 1) # only want rows where hyp_ID == 1
  
  ## For hypoxic events only lasting 1 data point (1 row), the duration will be 0. Change 0's to 1x recording frequency instead (0.25hr), as this is the
  # theoretical mean duration of that "event". For example, if recording freq is every 15 min, then one data point of hypoxia could 
  # represent 15 min of hypoxia prior to that sampling time or also 15 min of hypoxia until the next sampling event, so 15 min is mean
  
  event_hyp_5_24$dur_hrs <- with(event_hyp_5_24, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_4_24$dur_hrs <- with(event_hyp_4_24, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_3_24$dur_hrs <- with(event_hyp_3_24, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  event_hyp_2_24$dur_hrs <- with(event_hyp_2_24, replace(dur_hrs, dur_hrs == 0, 0.25))
  
  
  event_hyp_5_24 =  event_hyp_5_24 %>% 
    mutate(threshold = as.factor("5"))
  
  event_hyp_4_24 =  event_hyp_4_24 %>% 
    mutate(threshold = as.factor("4"))
  
  event_hyp_3_24 =  event_hyp_3_24 %>% 
    mutate(threshold = as.factor("3"))
  
  event_hyp_2_24 =  event_hyp_2_24 %>% 
    mutate(threshold = as.factor("2")) 
  
   events_hyp_all_24 = rbind(event_hyp_5_24,event_hyp_4_24,event_hyp_3_24,event_hyp_2_24)
  
  events_hyp_summary_24 = events_hyp_all_24 %>% 
    group_by(threshold) %>% 
    summarize(tot_dur = sum(dur_hrs),
              mean_dur = mean(dur_hrs),
              sd_dur = sd(dur_hrs))

```

## Sargassum Remote Sensing Data for 2023 and 2024

```{r}

sarg_sat <- read_excel("Sargassum_NDVI_DarkWater_Satellite_Data.xlsx", 
    col_types = c("date", "numeric", "text", 
        "numeric", "numeric")) %>% 
  rename(mask_area_m2=`Mask Area (mÂ²)`) %>% 
  rename(per_area=`Area of Coverage (%)`)

sarg_sat_AOI1 <- sarg_sat %>% filter(AOI == "1") %>% na.omit()
sarg_sat_AOI2 <- sarg_sat %>% filter(AOI == "2") %>% na.omit()
sarg_sat_AOI3 <- sarg_sat %>% filter(AOI == "3") %>% na.omit()

sarg_sat_AOI1_sarg <- sarg_sat_AOI1  %>% filter(Type == "NDVI/Sargassum Prescence")
sarg_sat_AOI2_sarg <- sarg_sat_AOI2  %>% filter(Type == "NDVI/Sargassum Prescence")
sarg_sat_AOI3_sarg <- sarg_sat_AOI3  %>% filter(Type == "NDVI/Sargassum Prescence")

sarg_sat_AOI1_dw <- sarg_sat_AOI1  %>% filter(Type == "Dark Water Events")
sarg_sat_AOI2_dw <- sarg_sat_AOI2  %>% filter(Type == "Dark Water Events")
sarg_sat_AOI3_dw <- sarg_sat_AOI3  %>% filter(Type == "Dark Water Events")

```


# Plotting

## Time Series Late Summer 2023 Plot(s)

```{r}

# Raw DO time series plot

common_breaks_23 <- seq(as.POSIXct("2023-08-21 UTC"), as.POSIXct("2023-09-24 UTC"), by = "weeks")

common_expand <- c(0.00, 1)

my_colors <- c("N" = "#b2182b", "NE" = "#d6604d", "E" = "#92c5de", "SE" = "#6baed6", "S" = "#4393c3", "SW" = "#2166ac", "W" = "#fecc5c", "NW" = "#f4a582")

DO_plot_23 =
  ggplot() +
  geom_hline(yintercept = seq(0, 11, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  scale_fill_manual(values = c("5" = "#d9d9d9", "4" = "#bdbdbd", "3" = "#969696","2" = "#e31a1c"),
                    labels = c("2", "3", "4", "5"),
                    name = "Thresholds (mg" ~ L^-1 * ")") +
  geom_rect(aes(xmin = as.POSIXct("2023-08-18 UTC"), 
                xmax = as.POSIXct("2023-09-26 UTC"), 
                ymin = 0, 
                ymax = 2, fill = "2"), 
            alpha = 1.0, color = NA, show.legend = TRUE) +
  geom_rect(aes(xmin = as.POSIXct("2023-08-18 UTC"), 
                xmax = as.POSIXct("2023-09-26 UTC"), 
                ymin = 2, 
                ymax = 3, fill = "3"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_rect(aes(xmin = as.POSIXct("2023-08-18 UTC"), 
                xmax = as.POSIXct("2023-09-26 UTC"), 
                ymin = 3, 
                ymax = 4, fill = "4"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_rect(aes(xmin = as.POSIXct("2023-08-18 UTC"), 
                xmax = as.POSIXct("2023-09-26 UTC"), 
                ymin = 4, 
                ymax = 5, fill = "5"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_line(data = DO_comparison_23, aes(x = datetime, y = median_DO_mg_L), size = 2) +
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) + 
  scale_x_datetime(breaks = common_breaks_23, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 11), expand = c(0.00, 0.00), breaks = seq(0, 11, 2), labels = scales::number_format(scale = 1)) +
  ylab(expression("DO (mg" ~ L^-1 * ")"))+
  xlab("") +
  labs(subtitle = "(E)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),
        axis.text.x = element_text(size = 40, margin = margin(t = 5)),
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),
        axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
       # axis.text.y = element_blank(),
        plot.margin = margin(t = 15, l = 15),
        panel.background = element_rect(fill = "white"), 
        plot.subtitle = element_text(size = 36, face = "bold") ,
        legend.key.size = unit(4, "lines"),
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 48),
        legend.position = "bottom"
        #legend.justification = c("left")
  )
  

#print(DO_plot_23)


temp_plot_23 =
  ggplot()+
  geom_hline(yintercept = seq(27, 33, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_line(data = DO_comparison_23,aes(x=datetime,y=median_temp),size = 2, color = "black")+
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
  ylab("Temperature (Â°C)")+
  #ylab("")+
  ggtitle("2023")+
  scale_x_datetime(breaks = common_breaks_23, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  xlab("")+
  scale_y_continuous(limits = c(27,33), expand = c(0.0,0.00),breaks = seq(27,33,2))+
  labs(subtitle = "(A)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
       #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        axis.text.y = element_text(size = 40, margin = margin(l = 5)),   # Add space to the left of y-axis numbers
        plot.title = element_text(hjust = 0.5, vjust = 1, size = 52, face = "bold", margin = margin(b = 10)),
        axis.text.x = element_blank(),
        #axis.text.y = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),#axis.ticks.y = element_line(color = "gray"),
        plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
        panel.background = element_rect(fill = "white"),
        plot.subtitle = element_text(size = 36, face = "bold") ,
        legend.key.size = unit(4, "lines"),  # Adjust the size of the legend key
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40)
       )

#print(temp_plot_23)


stick_wind_plot_23 <- 
    wind_data_23 %>%
    ggplot() +
    geom_hline(yintercept = seq(-12, 13, 2), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
    geom_segment(aes(x = Time,
                     y = 0,
                     xend = Time + lubridate::dhours(`Wind Speed (kn)`* 1 * -cos((90-`Wind Dir (deg)`) / 360 * 2 * pi)),
                     yend = `Wind Speed (kn)` * 1 * -sin((90-`Wind Dir (deg)`) / 360 * 2 * pi),
                     col = Sector
                     ),
                 arrow = arrow(length = unit(0.5, "cm")) )+
    geom_point(aes(Time, 0), size = 1) +
    
    coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
    scale_x_datetime(
   # limits = as_datetime(c("2023-08-17 UTC", "2023-09-26 UTC")),
    breaks = common_breaks_23,
    expand = common_expand,labels = function(x) format(x, "%m-%d")
  ) +
    scale_y_continuous(limits = c(-12,13), expand = c(0.00,0.00),breaks = seq(-12,13,6))+
    #ylab("Wind (kn)")+
    xlab("")+
    ylab("")+
    scale_color_manual(values = my_colors) +
    guides(
    color = guide_legend(
      title = "Compass Sector",
      keywidth = unit(3, "cm"),  # Adjust the size of the legend key
      keyheight = unit(1, "cm"),  # Adjust the size of the legend key
      override.aes = list(
        arrow = arrow(length = unit(20, "cm"), type = "closed", ends = "both", angle = 30)
    )
      )
       ) +
    labs(subtitle = "(D)") +
    theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
        #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        #axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        #axis.text.y = element_text(size = 40, margin = margin(l = 5)),   # Add space to the left of y-axis numbers
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
        panel.background = element_rect(fill = "white"), 
        plot.subtitle = element_text(size = 36, face = "bold") ,
        plot.title = element_text(hjust = 0.5, vjust = 1, size = 52, face = "bold", margin = margin(b = 10)),
        legend.key.size = unit(48, "lines"),  # Adjust the size of the legend key
        legend.text = element_text(size = 48),
        legend.title = element_text(size = 48),
        legend.position = "none"
       )


#print(stick_wind_plot_23)

stick_current_plot_23 = 
    currents_data_23 %>%
    ggplot() +
    geom_hline(yintercept = seq(-3, 3, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
    geom_segment(aes(x = Time,
                     y = 0,
                     xend = Time + lubridate::dhours(`Speed (cm/s)`* 1 * -cos((90-`Heading (degrees)`) / 360 * 2 * pi)),
                     yend = `Speed (cm/s)` * 1 * -sin((90-`Heading (degrees)`) / 360 * 2 * pi),
                     col = Sector
                     ),
                 arrow = arrow(length = unit(0.5, "cm")) )+
    geom_point(aes(Time, 0), size = 1) +
    coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
    scale_x_datetime(
    breaks = common_breaks_23,
    expand = common_expand,labels = function(x) format(x, "%m-%d")
  ) +
    scale_y_continuous(limits = c(-3,3), expand = c(0.0,0.00),breaks = seq(-3,3,2))+
    scale_color_manual(values = my_colors) +
    ylab(expression("\n Current (cm" ~ s^-1 * ")"))+
    xlab("")+
    scale_color_manual(values = my_colors) +
    labs(subtitle = "(C)") +
    theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    #    axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        axis.text.y = element_text(size = 40, margin = margin(l = 5)),   # Add space to the left of y-axis numbers
        axis.text.x = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
        panel.background = element_rect(fill = "white"), 
        plot.subtitle = element_text(size = 36, face = "bold") ,
        legend.key.size = unit(48, "lines"),  # Adjust the size of the legend key
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40),
        legend.position = "none"
       )


#print(stick_current_plot_23)

NOAA_water_level_plot_23 =
  ggplot()+
  #geom_hline(yintercept = seq(2,2.6,0.1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_hline(yintercept = seq(-0.1,0.6,0.1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) + # For NOAA data only
  geom_line(data = NOAA_water_level_23,aes(x=Time, y=`Verified (m)`),size = 2)+ # For NOAA data only
  #geom_line(data = NOAA_water_level_23,aes(x=Time, y=WL),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
  scale_x_datetime(
   # limits = as_datetime(c("2023-08-17 UTC", "2023-09-26 UTC")),
    breaks = common_breaks_23,
    expand = common_expand,labels = function(x) format(x, "%m-%d")
  ) +
  #scale_y_continuous(limits = c(2,2.6), expand = c(0.0,0.00),breaks = seq(2,2.6,0.2))+
  scale_y_continuous(limits = c(-0.1,0.6), expand = c(0.0,0.00),breaks = seq(-0.1,0.6,0.2))+ # For NOAA data only
  #ylab("Water Level (m)")+
  ylab("")+
  xlab("")+
  labs(subtitle = "(B)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    #    axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        #axis.text.y = element_text(size = 40, margin = margin(l = 5)),   # Add space to the left of y-axis numbers
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
       # panel.grid.major = element_line(color = "gray", size = 0.1),             # Remove major grid lines
       # panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"), 
        plot.subtitle = element_text(size = 36, face = "bold") ,
        legend.key.size = unit(4, "lines"),  # Adjust the size of the legend key
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40)
       )

print(NOAA_water_level_plot_23)



# Extract DO legend 

legend <- cowplot::get_legend(DO_plot_23)

# Remove legends from each plot
temp_plot_23 <- temp_plot_23 + theme(legend.position = "none")
NOAA_water_level_plot_23 <- NOAA_water_level_plot_23 + theme(legend.position = "none")
stick_current_plot_23 <- stick_current_plot_23 + theme(legend.position = "none")
stick_wind_plot_23 <- stick_wind_plot_23 + theme(legend.position = "none")
DO_plot_23 <- DO_plot_23 + theme(legend.position = "none")


## Combine the plots with labels
ts_plot_23 <- temp_plot_23 + 
              NOAA_water_level_plot_23 +
              stick_current_plot_23 + 
              stick_wind_plot_23 + 
              DO_plot_23 + 
              plot_layout(ncol = 1)

print(ts_plot_23)

#ggsave("ts_plot_23.jpg",ts_plot_23,width = 32, height = 24)
```

## Time Series Late Winter 2024 Plot(s)

```{r}
# Raw DO plot
common_breaks_24 <- seq(as.POSIXct("2024-03-11 UTC"), as.POSIXct("2024-04-06 UTC"), by = "weeks")
#common_exp = c(0.02, 0.02)labels = function(x) format(x, "%m-%d")
common_expand <- c(0.00, 1)

my_colors <- c("N" = "#b2182b", "NE" = "#d6604d", "E" = "#92c5de", "SE" = "#6baed6", "S" = "#4393c3", "SW" = "#2166ac", "W" = "#fecc5c", "NW" = "#f4a582")

 

DO_plot_24 =
  #oxy_data %>% 
  ggplot() +
  geom_hline(yintercept = seq(0, 11, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_rect(aes(xmin = as.POSIXct("2024-03-06 UTC"), 
                xmax = as.POSIXct("2024-04-08 UTC"), 
                ymin = 0, 
                ymax = 2, fill = "2"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_rect(aes(xmin = as.POSIXct("2024-03-06 UTC"), 
                xmax = as.POSIXct("2024-04-08 UTC"), 
                ymin = 2, 
                ymax = 3, fill = "3"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_rect(aes(xmin = as.POSIXct("2024-03-06 UTC"), 
                xmax = as.POSIXct("2024-04-08 UTC"), 
                ymin = 3, 
                ymax = 4, fill = "4"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_rect(aes(xmin = as.POSIXct("2024-03-06 UTC"), 
                xmax = as.POSIXct("2024-04-08 UTC"), 
                ymin = 4, 
                ymax = 5, fill = "5"), 
            alpha = 0.9, color = NA, show.legend = TRUE) +
  geom_line(data = DO_comparison_24, aes(x = datetime, y = mean_DO_mg_L), size = 2) +
  scale_fill_manual(values = c("2" = "#e31a1c", "3" = "#969696", "4" = "#bdbdbd", "5" = "#d9d9d9"),
                    labels = rev(c("5", "4", "3", "2")),
                    name = "Thresholds (mg/L)") +
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) + 
  scale_x_datetime(breaks = common_breaks_24, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(position = "right",limits = c(0, 11), expand = c(0.00, 0.00), breaks = seq(0, 11, 2), labels = scales::number_format(scale = 1)) +
# ylab(expression("DO (mg" ~ L^-1 * ")"))+
  xlab("")+
  ylab("")+
  labs(subtitle = "(J)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),
        axis.text.x = element_text(size = 40, margin = margin(t = 5)),
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),
       # axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
        axis.text.y = element_blank(),
        plot.margin = margin(t = 15, l = 15),
        panel.background = element_rect(fill = "white"), 
        plot.subtitle = element_text(size = 36, face = "bold") ,
        legend.key.size = unit(4, "lines"),
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40),
        legend.position = "none"
  )
print(DO_plot_24)

temp_plot_24 =
  ggplot()+
  geom_hline(yintercept = seq(27, 33, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_line(data = DO_comparison_24,aes(x= datetime,y= mean_temp),size = 2, color = "black")+
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), ylim = c(27, 33), expand = FALSE) +
  #ylab("Temperature (Â°C) \n")+
  scale_x_datetime(
    breaks = common_breaks_24,
    expand = common_expand,labels = function(x) format(x, "%m-%d")
  ) +
  xlab("")+
  ylab("")+
  ggtitle("2024")+
  scale_y_continuous(position = "right",limits = c(27,33), expand = c(0.0,0.00),breaks = seq(27,33,2))+
  labs(subtitle = "(F)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
        axis.title.y = element_text(size = 40, margin = margin(r = 10)), 
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
       # axis.text.y = element_blank(),# Add space to the right of y-axis title
        #axis.text.y = element_text(size = 40, margin = margin(l = 5)),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
        # Add space to the left of y-axis numbers
        plot.margin = margin(t = 15, l = 15),
        plot.title = element_text(hjust = 0.5, vjust = 1, size = 52, face = "bold", margin = margin(b = 10)),# Adjust axis tick size
        plot.subtitle = element_text(size = 36, face = "bold"),
        panel.background = element_rect(fill = "white"), 
        legend.key.size = unit(4, "lines"),  # Adjust the size of the legend key
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40)
       )

print(temp_plot_24)

stick_wind_plot_24 <- 
    wind_data_24 %>%
    ggplot() +
    geom_hline(yintercept = seq(-12, 13, 2), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
    geom_segment(aes(x = Time,
                     y = 0,
                     xend = Time + lubridate::dhours(`Wind Speed (kn)`* 1 * -cos((90-`Wind Dir (deg)`) / 360 * 2 * pi)),
                     yend = `Wind Speed (kn)` * 1 * -sin((90-`Wind Dir (deg)`) / 360 * 2 * pi),
                     col = Sector
                     ),
                 arrow = arrow(length = unit(0.5, "cm")) )+
    geom_point(aes(Time, 0), size = 1) +
    
    coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) +
    scale_x_datetime(
    breaks = common_breaks_24,
    expand = common_expand,labels = function(x) format(x, "%m-%d")
  ) +
    scale_y_continuous(position = "right",limits = c(-12,13), expand = c(0.00,0.00),breaks = seq(-12,13,6))+
    ylab("Wind (kn) \n")+
    xlab("")+
  #  ylab("")+
    scale_color_manual(values = my_colors) +
    labs(subtitle = "(I)") +
    theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
        #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        axis.text.y = element_text(size = 40, margin = margin(l = 5)),
        axis.text.x = element_blank(),
       # axis.text.y = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
        plot.title = element_text(hjust = 0.5, vjust = 1, size = 52, face = "bold", margin = margin(b = 10)),
        plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
        plot.subtitle = element_text(size = 36, face = "bold") ,
        panel.background = element_rect(fill = "white"), 
        legend.key.size = unit(48, "lines"),  # Adjust the size of the legend key
        legend.text = element_text(size = 48),
        legend.title = element_text(size = 48),
        legend.position = "none"
       )

#print(stick_wind_plot_24)

stick_current_plot_24 = 
    current_data_24 %>%
    ggplot() +
    geom_hline(yintercept = seq(-3, 3, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
    geom_segment(aes(x = Time,
                     y = 0,
                     xend = Time + lubridate::dhours(`Speed (cm/s)`* 1 * -cos((90-`Heading (degrees)`) / 360 * 2 * pi)),
                     yend = `Speed (cm/s)` * 1 * -sin((90-`Heading (degrees)`) / 360 * 2 * pi),
                     col = Sector
                     ),
                 arrow = arrow(length = unit(0.5, "cm")) )+
    geom_point(aes(Time, 0), size = 1) +
    coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) +
    scale_x_datetime(
    breaks = common_breaks_24,
    expand = common_expand,labels = function(x) format(x, "%m-%d")
  ) +
    scale_y_continuous(position = "right",limits = c(-3,3), expand = c(0.0,0.00),breaks = seq(-3,3,2))+
    scale_color_manual(values = my_colors) +
 #   ylab("\n Current (cm/s)")+
    xlab("")+
    ylab("")+
    labs(subtitle = "(H)") +
    scale_color_manual(values = my_colors) +
    theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
       # axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        #axis.text.y = element_text(size = 40, margin = margin(l = 5)),   # Add space to the left of y-axis numbers
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
        plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
        plot.subtitle = element_text(size = 36, face = "bold") ,
        panel.background = element_rect(fill = "white"),
        legend.position = "none"
       )


#print(stick_current_plot_24)

NOAA_water_level_plot_24 =
  ggplot()+
  geom_hline(yintercept = seq(-0.1, 0.6, 0.1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_line(data = NOAA_water_level_24, aes(x = Time, y = `Verified (m)`), size = 2) +
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) +
  scale_x_datetime(
    breaks = common_breaks_24,
    expand = common_expand,
    labels = function(x) format(x, "%m-%d")
  ) +
  scale_y_continuous(position = "right",limits = c(-.1, 0.6), expand = c(0.0, 0.00), breaks = seq(-0.1, 0.6, 0.2)) +
  ylab(" Water Level (m)")+
  #ylab("")+
  xlab("")+
  labs(subtitle = "(G)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
        #axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
        #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
        axis.text.y = element_text(size = 40, margin = margin(l = 5)),   # Add space to the left of y-axis numbers
        axis.text.x = element_blank(),
        #axis.text.y = element_blank(),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
        plot.margin = margin(t = 15, l = 15),# Adjust axis tick size
        plot.subtitle = element_text(size = 36, face = "bold") ,
       # panel.grid.major = element_line(color = "gray", size = 0.1),             # Remove major grid lines
       # panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white")
       )
  
  

#print(NOAA_water_level_plot_24)


# Remove legends from each plot just in case
temp_plot_24 <- temp_plot_24 + theme(legend.position = "none")
NOAA_water_level_plot_24 <- NOAA_water_level_plot_24 + theme(legend.position = "none")
stick_current_plot_24 <- stick_current_plot_24 + theme(legend.position = "none")
stick_wind_plot_24 <- stick_wind_plot_24 + theme(legend.position = "none")
DO_plot_24 <- DO_plot_24 + theme(legend.position = "none")

ts_plot_24 <- temp_plot_24 + 
              NOAA_water_level_plot_24 +
              stick_current_plot_24 + 
              stick_wind_plot_24 + 
              DO_plot_24 + 
              plot_layout(ncol = 1)

ts_plot <- cowplot::plot_grid(ts_plot_23, ts_plot_24, ncol = 2, align = "h") # Combine both 2023 and 2024 time series plot into one figure

# Add legend to ts_plot

ts_legend_plot <- cowplot::plot_grid(ts_plot, NULL, legend, ncol = 1, rel_heights = c(1, 0.01, 0.05), align = "v")

#ggsave("ts_plot.pdf",ts_legend_plot,width = 32, height = 24)
#ggsave("ts_plot.jpg",ts_legend_plot,width = 32, height = 24)






```


# Duration Plots

```{r}
plot_duration_threshold_23 <- ggplot() +
  geom_hline(yintercept = seq(0, 20, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  scale_fill_manual(values = c("5" = "#d9d9d9", "4" = "#bdbdbd", "3" = "#969696","2" = "#e31a1c"),
                    labels = c("5", "4", "3", "2"),
                    name = "Thresholds (mg/L)") +
  geom_bar(data = event_hyp_5, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  geom_bar(data = event_hyp_4, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  geom_bar(data = event_hyp_3, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  geom_bar(data = event_hyp_2, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  labs(title = " ", x = " ", y = "Duration (hours)\n", fill = "Threshold (mg/L)") +
  scale_x_date(date_labels = "%m-%d", date_breaks = "weeks", expand = c(0, 1)) +
  scale_y_continuous(limits = c(0, 20), expand = c(0, 0), breaks = seq(0, 20, 5)) +
  labs(subtitle = "(A)") +
  ggtitle("2023")+
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
   # axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold"),# Adjust the size of the legend key
    plot.title = element_text(hjust = 0.5, vjust = 1, size = 52, face = "bold", margin = margin(b = 10)),
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    legend.position = "none"
  )  # Adjust the theme as needed

#print(plot_duration_threshold_23)

plot_duration_threshold_24 <- ggplot() +
  geom_hline(yintercept = seq(0, 20, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_bar(data = event_hyp_5_24, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  geom_bar(data = event_hyp_4_24, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  geom_bar(data = event_hyp_3_24, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  geom_bar(data = event_hyp_2_24, aes(x = Date, y = dur_hrs, fill = factor(threshold)), stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(values = c("#d9d9d9", "#bdbdbd", "#969696", "#e31a1c")) +
  labs(title = " ", x = " ", y = "Duration (hours)", fill = "Threshold (mg/L)") +
  ylab("")+
  scale_x_date(date_labels = "%m-%d", date_breaks = "week", expand = c(0, 1)) +
  scale_y_continuous(limits = c(0, 20), expand = c(0, 0), breaks = seq(0, 20, 5)) + 
  labs(subtitle = "(C)") +
  ggtitle("2024")+
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    #axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    axis.text.y = element_blank(),
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold"),# Adjust the size of the legend key
    plot.title = element_text(hjust = 0.5, vjust = 1, size = 52, face = "bold", margin = margin(b = 10)),
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    legend.position = "none"
  )  # Adjust the theme as needed

#print(plot_duration_threshold_24)


AOI1_sarg_msk_sum = ggplot()+
  geom_hline(yintercept = seq(0, 25, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = sarg_sat_AOI1_sarg, aes(x = Date, y = per_area),size = 8, color = "black")+
  geom_line(data = sarg_sat_AOI1_sarg, aes(x = Date, y = per_area),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_23, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 25), expand = c(0, 0), breaks = seq(0, 25, 5)) +# For mask area
  ggtitle("Study Site")+
  xlab("")+
  ylab("Sargassum Coverage (%)\n")+
  labs(subtitle = "(B)") +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    #axis.text.x = element_blank(),
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold") ,# Adjust the size of the legend key
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.position = "none"
  )  # Adjust the theme as needed


#print(AOI1_sarg_msk_sum)

AOI1_sarg_msk_win = ggplot()+
  geom_hline(yintercept = seq(0, 25, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = sarg_sat_AOI1_sarg, aes(x = Date, y = per_area),size = 8,color = "black")+
  geom_line(data = sarg_sat_AOI1_sarg, aes(x = Date, y = per_area),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_24, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 25), expand = c(0, 0), breaks = seq(0, 25, 5)) +# For mask area
  ggtitle("Study Site")+
  xlab("")+
 # ylab("Sargassum Coverage (%)")+
  ylab("")+
  labs(subtitle = "(D)") +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    #axis.text.x = element_blank(),
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    #axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    axis.text.y = element_blank(),
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold") ,# Adjust the size of the legend key
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.position = "none"
  )  # Adjust the theme as needed

#print(AOI1_sarg_msk_win)
 
sum_bar_plot = plot_duration_threshold_23 + AOI1_sarg_msk_sum +  plot_layout(ncol = 1) # Combine 2023 figures into one column

win_bar_plot = plot_duration_threshold_24 + AOI1_sarg_msk_win +  plot_layout(ncol = 1) # Combine 2024 figures into one column

# Combine the plots side by side with summer on the right and winter on the left
combined_plot <- plot_grid(sum_bar_plot, win_bar_plot, ncol = 2)

# Add threshold legend to figure 
dur_sarg_plot <- cowplot::plot_grid(
  combined_plot, NULL, legend,
  ncol = 1,
  rel_heights = c(1, 0.01, 0.05),
  align = "v"
)

#print(dur_sarg_plot)

ggsave("dur_sarg_plot.jpg",dur_sarg_plot, width = 32, height = 24)


```

# Incubations

```{r}

#import incubation data and rename columns
incubations = read_excel("MS_Thesis_JM_Sarg_Incubations.xlsx") %>% 
  filter(!str_detect(Sample, 'GGA')) %>% 
  rename(deltaDO_mg=`DeltaDO(mg)`) %>% 
  rename(Sargasso_mg=`Sargassum weight (mg)`) %>% 
  mutate(duration=difftime(`Date End`,`Date Started`,units="days")+difftime(`Time End`,`Time Start`,units="days")) %>% 
  mutate(deltaDO_mg.day=deltaDO_mg/as.numeric(duration))

#generate lme with random slopes and intercepts by incubation ID
sargasso_lme=lme(deltaDO_mg.day~Sargasso_mg,random=~Sargasso_mg|ID,data=incubations)


summary(sargasso_lme)

R2 = rsq.lmm(sargasso_lme)

summary(R2)

incubations_plot =
  ggpredict(sargasso_lme, "Sargasso_mg", type = "re",ci_level=0.95,interval="confidence") %>% 
  plot(show_data = T, dot_alpha = 0.2)+
  geom_hline(yintercept = seq(0, 0.6, 0.1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = incubations, aes(x = Sargasso_mg, y = deltaDO_mg.day),size = 8, color = "black",stroke = 2)+
  xlab("\n Sargassum (mg)")+
  ylab(expression(paste(Delta, "Dissolved Oxygen (mg" ~ d^-1 * ")")))+
  ggtitle("")+
  scale_y_continuous(limits = c(0, 0.6), expand = c(0.00, 0.00), breaks = seq(0, 0.6, 0.1)) +
  scale_x_continuous(limits = c(0, 110), expand = c(0.015, 0.015), breaks = seq(0, 100, 20)) +
  labs(subtitle = "(A)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),
        axis.title.x = element_text(size = 40, margin = margin(b = 10), color = "black"),
        axis.text.x = element_text(size = 40, margin = margin(t = 5), color = "black"),
        axis.title.y = element_text(size = 40, margin = margin(r = 10), color = "black"),
        axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5), color = "black"),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
       # plot.margin = margin(t = 15, l = 15),
        plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm"),
        panel.background = element_rect(fill = "white"),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),
        plot.subtitle = element_text(size = 36, face = "bold") ,
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40),
        #axis.line.y = element_line(color = "black"),
        axis.line.x = element_line(color = "black"),
        legend.position = "none"
  )
  
#print(incubations_plot)

ggsave("incubations_plot.jpg",incubations_plot,width = 32, height = 24)

min_DO_Model_mgL <- ggplot(min_O2_per_day, aes(x = sarg_kg, y = min_O2_mg_L, color = factor(temp), shape = factor(tau), linetype = factor(tau))) +
  scale_fill_manual(values = c("5" = "#d9d9d9", "4" = "#bdbdbd", "3" = "#969696","2" = "#e31a1c"),
                    labels = c("2", "3", "4", "5"),
                    name = "Thresholds (mg/L)") +
  geom_rect(aes(xmin = 0, 
                xmax = 10, 
                ymin = -0.030, 
                ymax = 2, fill = "2"), 
            alpha = 1.0, color = NA, show.legend = FALSE) +
  geom_rect(aes(xmin = 0, 
                xmax = 10, 
                ymin = 2, 
                ymax = 3, fill = "3"), 
            alpha = 0.9, color = NA, show.legend = FALSE) +
  geom_rect(aes(xmin = 0, 
                xmax = 10, 
                ymin = 3, 
                ymax = 4, fill = "4"), 
            alpha = 0.9, color = NA, show.legend = FALSE) +
  geom_rect(aes(xmin = 0, 
                xmax = 10, 
                ymin = 4, 
                ymax = 5, fill = "5"), 
            alpha = 0.9, color = NA, show.legend = FALSE) +
  #geom_point(size = 12) +
  geom_point(size = 12, stroke = 2)+#, position = position_jitter(width = 0), stroke = 2) +
  geom_line(linewidth = 3,aes(linetype = factor(tau)))+
  scale_y_continuous(limits = c(-0.030, 6.5), expand = c(0.00, 0.00), breaks = seq(0, 6, 1)) +#-1.89461038
  #scale_y_continuous(limits = c(-1.89461038, 6), expand = c(0.00, 0.00), breaks = seq(0, 6, 1)) +
  scale_x_continuous(limits = c(0, 10), expand = c(0.00, 0.00), breaks = seq(1, 10, 1)) +
  labs(x = "\n Sargassum (kg)", y = expression("Nightly Minimum Dissolved Oxygen (mg " ~ L^-1 * ")")) +
  #scale_color_manual(name = "Temperature", values = c("#8856a7", "#31a354"), labels = c("28Â°C", "31Â°C")) +
  #scale_color_manual(name = "Temperature:", values = c("#2166ac", "#fdae61"), labels = c("28Â°C", "31Â°C")) +
  scale_color_manual(name = "Temperature", values = c("#053061","#2166ac"), labels = c("28Â°C", "31Â°C")) +
  scale_shape_manual(name = "Residence Time", values = c("1" = 1, "5" = 15), labels = c("1 hr", "5 hr")) +
  scale_linetype_manual(name = "Residence Time", values = c("1" = "dashed", "5" = "solid"),labels = c("1 hr", "5 hr")) +
 # scale_linetype_manual(name = "Residence Time", values = c("1" = 4,2, "5" = "solid"), labels = c("1 hr", "5 hr")) +
  #theme_minimal()
  labs(subtitle = "(B)") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.0),
        axis.title.x = element_text(size = 40, margin = margin(b = 10)),
        axis.text.x = element_text(size = 40, margin = margin(t = 5)),
        axis.title.y = element_text(size = 40, margin = margin(r = 10)),
        axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5) ),
        axis.ticks.length = unit(0.5, "cm"),
        axis.ticks = element_line(size = 1),
       # plot.margin = margin(t = 15, l = 15),
        plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm"),
        panel.background = element_rect(fill = "white"),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),
        plot.subtitle = element_text(size = 36, face = "bold"),
        legend.key.size = unit(4, "lines"),
        legend.text = element_text(size = 40),
        legend.title = element_text(size = 40),
        legend.position = "bottom"
  )

#print(min_DO_Model_mgL)



#ggsave("min_DO_Model.jpg",min_DO_Model_mgL,width = 32, height = 24)




sargasso_plot <- cowplot::plot_grid(incubations_plot, min_DO_Model_mgL, ncol = 1, align = 'v')

sargassum_DO_legend_plot <- cowplot::plot_grid(sargasso_plot, NULL, legend, ncol = 1, rel_heights = c(1, 0.0001, 0.05), align = "v")


#ggsave("sargasso_DO_leg_plot.jpg",sargassum_DO_legend_plot,width = 32, height = 24)

ggsave("sargasso_DO_leg_plot_narrow.jpg",sargassum_DO_legend_plot,width = 21, height = 24)

#ggsave("sargasso_DO_leg_plot.pdf",sargassum_DO_legend_plot,width = 32, height = 24)



```


# Supplemental Figures

## Raw DO sensor 2023 Data

```{r}

raw_DO_median_2023 <- ggplot(data = DO_comparison_23) +
  geom_hline(yintercept = seq(0, 15.5, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_line(mapping = aes(x = as.POSIXct(datetime), y = S1_ts, color = "S1"), size = 2) +
  geom_line(mapping = aes(x = as.POSIXct(datetime), y = S2_ts, color = "S2"), size = 2) +
  geom_line(mapping = aes(x = as.POSIXct(datetime), y = S3_ts, color = "S3"), size = 2) +
  geom_line(mapping = aes(x = as.POSIXct(datetime), y = S4_ts, color = "S4"), size = 2) +
  geom_line(mapping = aes(x = as.POSIXct(datetime), y = median_DO_mg_L, color = "Median"), size = 2) +
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_23, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 15.5), expand = c(0.00, 0.00), breaks = seq(0, 15.5, 5)) +
  ylab(expression("DO (mg" ~ L^-1 * ")")) +
  xlab("") +
  scale_color_manual(
    name = "Legend",
    values = c(
      "Median" = "black",
      "S4" = "#33a02c",
      "S3" = "#b2df8a",
      "S2" = "#1f78b4",
      "S1" = "#a6cee3"
    ),
   # labels = c("Median", "S4", "S3", "S2", "S1")
  ) +
  labs(subtitle = "(A)") +
  ggtitle("2023")+
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),
    axis.text.x = element_text(size = 40, margin = margin(t = 5)),
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),
    axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),
    axis.ticks.length = unit(0.5, "cm"),
    axis.ticks = element_line(size = 1),
    plot.margin = margin(t = 15, l = 15),
    panel.background = element_rect(fill = "white"),
    plot.subtitle = element_text(size = 36, face = "bold"),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.title = element_blank(),
    legend.position = c(0.8, 0.75), # Positioning the legend inside the plot
    legend.key.size = unit(4, "lines"),
    legend.text = element_text(size = 40),
    legend.background = element_rect(fill = "white", color = "black", size = 0.5)
  )

print(raw_DO_median_2023)

raw_DO_median_2024 <- ggplot(data = DO_comparison_24) +
  geom_hline(yintercept = seq(0, 15.5, 1), color = "gray", linetype = "solid", size = 1, alpha = 0.5) + 
  geom_line(mapping = aes(x = datetime, y = X2_ts, color = "X2"), size = 2) +
  geom_line(mapping = aes(x = datetime, y = X1_ts, color = "X1"), size = 2) +
  geom_line(mapping = aes(x = datetime, y = mean_DO_mg_L, color = "Mean"), size = 2) +
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) + 
  scale_x_datetime(breaks = common_breaks_24, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 15.5), expand = c(0.00, 0.00), breaks = seq(0, 15.5, 5)) +
  ylab(expression("DO (mg" ~ L^-1 * ")")) +
  xlab("")+
  #ylab("")+
  scale_color_manual(
    name = "Legend",
    values = c(
      "Mean" = "black",
      "X1" = "#5e3c99",
      "X2" = "#b2abd2"
    ),

  ) +
  labs(subtitle = "(B)") +
  ggtitle("2024")+
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),
    #axis.text.y = element_blank(),
    axis.text.x = element_text(size = 40, margin = margin(t = 5)),
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),
    axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),
    axis.ticks.length = unit(0.5, "cm"),
    axis.ticks = element_line(size = 1),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    plot.margin = margin(t = 15, l = 15),
    panel.background = element_rect(fill = "white"),
    plot.subtitle = element_text(size = 36, face = "bold"),
    legend.title = element_blank(),
    legend.position = c(0.7, 0.85), # Positioning the legend inside the plot
    legend.key.size = unit(4, "lines"),
    legend.text = element_text(size = 40),
    legend.background = element_rect(fill = "white", color = "black", size = 0.5)
  )

#print(raw_DO_median_2024)

raw_DO_plots = raw_DO_median_2023 + raw_DO_median_2024 +  plot_layout(ncol = 1)

#ggsave("raw_DO_median_2024.jpg",raw_DO_median_2024,width = 32, height = 24)

#ggsave("raw_DO_plots.jpg",raw_DO_plots,width = 32, height = 24)
```

## Satellite Sargassum Figures

```{r}
# Isla Magueyes Sargassum Satellite

AOI2_sarg_msk_sum = ggplot()+
  geom_hline(yintercept = seq(0, 25, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = sarg_sat_AOI2_sarg, aes(x = Date, y = per_area),size = 8)+
  geom_line(data = sarg_sat_AOI2_sarg, aes(x = Date, y = per_area),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_23, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 25), expand = c(0, 0), breaks = seq(0, 25, 5)) +
  ggtitle("Isla Magueyes")+ 
  xlab("")+
  ylab("Sargassum Coverage (%)\n")+
  labs(subtitle = "(B)") +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    #axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
   # axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    #axis.text.y = element_blank(),
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.text.x = element_blank(),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold") ,# Adjust the size of the legend key
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.position = "none"
  )  # Adjust the theme as needed

#print(AOI2_sarg_msk_sum)

AOI2_sarg_msk_win = ggplot()+
  geom_hline(yintercept = seq(0, 25, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = sarg_sat_AOI2_sarg, aes(x = Date, y = per_area),size = 8)+
  geom_line(data = sarg_sat_AOI2_sarg, aes(x = Date, y = per_area),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_24, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 25), expand = c(0, 0), breaks = seq(0, 25, 5)) +
  ggtitle("Isla Magueyes")+ 
  xlab("")+
  #ylab("Sargassum Coverage (%)\n")+
  ylab("")+
  labs(subtitle = "(E)") +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
   # axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    #axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold") ,# Adjust the size of the legend key
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.position = "none"
  )  # Adjust the theme as needed)

#print(AOI2_sarg_msk_win)


# Isla Magueyes Sargassum Satellite

AOI3_sarg_msk_sum = ggplot()+
  geom_hline(yintercept = seq(0, 25, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = sarg_sat_AOI3_sarg, aes(x = Date, y = per_area),size = 8)+
  geom_line(data = sarg_sat_AOI3_sarg, aes(x = Date, y = per_area),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2023-08-18 UTC", "2023-09-26 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_23, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  #scale_y_continuous(limits = c(0, 2.5), expand = c(0, 0), breaks = seq(0, 2.5, 0.5)) +
  scale_y_continuous(limits = c(0, 25), expand = c(0, 0), breaks = seq(0, 25, 5)) +
  ggtitle("La Parguera")+ 
  xlab("")+
  ylab("Sargassum Coverage (%)\n")+
  labs(subtitle = "(A)") +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    #axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold") ,# Adjust the size of the legend key
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.position = "none"
  )  # Adjust the theme as needed

#print(AOI3_sarg_msk_sum)

AOI3_sarg_msk_win = ggplot()+
  geom_hline(yintercept = seq(0, 25, 2.5), color = "gray", linetype = "solid", size = 1, alpha = 0.5) +
  geom_point(data = sarg_sat_AOI3_sarg, aes(x = Date, y = per_area),size = 8)+
  geom_line(data = sarg_sat_AOI3_sarg, aes(x = Date, y = per_area),size = 2)+
  coord_cartesian(xlim = as.POSIXct(c("2024-03-06 UTC", "2024-04-08 UTC")), expand = FALSE) +
  scale_x_datetime(breaks = common_breaks_24, expand = common_expand, labels = function(x) format(x, "%m-%d")) +
  scale_y_continuous(limits = c(0, 25), expand = c(0, 0), breaks = seq(0, 25, 5)) +
  ggtitle("La Parguera")+ 
  xlab("")+
  #ylab("Sargassum Coverage (%)\n")+
  ylab("")+
  labs(subtitle = "(D)") +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1.0),  # Create a border around the plot
    axis.title.x = element_text(size = 40, margin = margin(b = 10)),  # Add space below x-axis title
    #axis.text.x = element_text(size = 40, margin = margin(t = 5)),     # Add space above x-axis numbers
    axis.title.y = element_text(size = 40, margin = margin(r = 10)),   # Add space to the right of y-axis title
    #axis.text.y = element_text(size = 40, margin = margin(l = 5, t = 5)),   # Add space to the left of y-axis numbers
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_line(linewidth = 1,size = 1.5),
    axis.ticks.length = unit(0.5, "cm"),
    panel.background = element_rect(fill = "white"),
    legend.key.size = unit(4, "lines"),
    plot.subtitle = element_text(size = 36, face = "bold") ,# Adjust the size of the legend key
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    plot.title = element_text(size = 48, face = "bold", hjust = 0.5),
    legend.position = "none"
  )  # Adjust the theme as needed)

#print(AOI3_sarg_msk_win)


AOI1_sarg_msk_sum = AOI1_sarg_msk_sum + labs(subtitle = "(C)") 
AOI1_sarg_msk_win = AOI1_sarg_msk_win + labs(subtitle = "(F)") 

sat_plot_sarg_sum = (AOI3_sarg_msk_sum + AOI2_sarg_msk_sum + AOI1_sarg_msk_sum) + plot_layout(ncol = 1)

sat_plot_sarg_win = (AOI3_sarg_msk_win + AOI2_sarg_msk_win + AOI1_sarg_msk_win) + plot_layout(ncol = 1)

sarg_sat_plot = cowplot::plot_grid(sat_plot_sarg_sum, sat_plot_sarg_win, ncol = 2)

ggsave("sarg_sat_plot.jpg",sarg_sat_plot,width = 32, height = 24)

```